<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta charset="utf-8">
  <script src="static/d3.v5.js"></script>
  <script src="static/topojson-client.js"></script>
  <script src="static/d3-simple-slider.min.js"></script>
  <!-- <script type="module" src="static/versor.js"></script> -->
  <!-- https://picnicss.com/documentation -->
  <link rel="stylesheet" type="text/css" href="static/picnic.min.css">
  <style type="text/css">
  body {
    margin: auto;
    max-width: 640px;
    text-align: center;
  }
  svg {
   /* width: 1280px;
    height: 800px;
    pointer-events: all;*/
  }
  sup {
    font-size: x-small
  }
  #footer {
    margin: auto;
    max-width: 640px;
    text-align: left;
  }
  </style>
</head>

<body onload="reset();">
  <div>
    <h3>Canadian Airlines and COVID19</h3>
    <p>In March 2020, COVID19 there was a reduction in the number of flights per day from Canadian airlines
  Number of flights from . Data used </p> 
  </div>
  <div><span>Flights on March </span><span id="value-time"></span><sup id="value-time-sup"></sup></div>
  <div>
    <!-- map -->
    <svg id="map" width="640" height="640"></svg>
    <i style="font-size: 14px; color: #AAA;">Drag to rotate the world</i>
  </div>
  <div id="footer" class="row align-items-center">
    <span style="font-size: 14px; margin-left: 120px; color: #AAA;">Day of March:</span>
    <div class="col-sm" style="display: flex;">
      <button id="play" onclick="play();" style="height: 37px; margin-right: 5px; margin-top: 12px;" >▶</button>
      <button id="pause" onclick="pause();" style="height: 37px; width: 51px; margin-top: 12px;" disabled="">▌▌</button>
      <span id="slider-time" onclick="pause();"></span>
    </div>
  </div>
  <div id="footer-text">
     <a href="download.csv" download>csv</a>
  </div>
</body>

<script>
// Lots of code from:
//  http://bl.ocks.org/dwtkns/4686432
//  http://mbostock.github.io/d3/talk/20111018/azimuthal.html
//  ideal: https://observablehq.com/@d3/versor-dragging

  let colourPath    = "#1E88E510";
  let colourSphere  = "#F8F8F8";
  let colourLand    = "#AAA";
// D3 Map
  // The svg
  let svg = d3.select("svg")
            .on("mousedown", mousedown),
    width = +svg.attr("width"),
    height = +svg.attr("height");

  // Map and projection
  // projections: geoMercator, geoNaturalEarth1
  let projection = d3.geoOrthographic()
    .scale(220)
    .translate([320,320])
    .clipAngle(90)
    .rotate([90,-25,0]);

  // Path generator
  let path = d3.geoPath()
      .projection(projection);

  // Load world shape
  d3.json("static/land-110m.json")
    .then(function(world) {

      var sphere = {type:"Sphere"};
    
      svg.append("path")
        .datum(sphere)
        .attr("d", path)
        .attr("fill", colourSphere);

      // Draw map
      svg.insert("path", ".graticule")
          .datum(topojson.feature(world, world.objects.land))
          .attr("class", "land")
          .attr("fill", colourLand)
          .style("stroke", colourLand)
          .attr("d", path);

  });

  // Load flights data
  var link;
  d3.json("data.json")
    .then(function(data) {
    link = data;

    // Add paths
    svg.selectAll("myPath")
      .data(link[0])
      .enter().append("path")
        .attr("class", "lines")  // need to specify class
        .attr("d", function(d){ return path(d)})
        .style("fill", "none")
        .style("stroke", colourPath)
        .style("stroke-width", 2);
  });

  d3.select(window)
    .on("mousemove", mousemove)
    .on("mouseup", mouseup);

  let m0, o0;

  function mousedown() {
    m0 = [d3.event.pageX, d3.event.pageY];
    o0 = projection.rotate();
    d3.event.preventDefault();
  }

  function mousemove() {
    if (m0) {
      let m1 = [d3.event.pageX, d3.event.pageY],
          o1 = [o0[0] + (m1[0] - m0[0]) / 6, o0[1] + (m0[1] - m1[1]) / 6];
      projection.rotate(o1);
      svg.selectAll("path")
       .attr("d", path);
      // refresh();
    }
  }

  function mouseup() {
    if (m0) {
      mousemove();
      m0 = null;
    }
  }

  // SLIDER    
   // Time
  let dataTime = d3.range(1, 32);

  let sliderTime = d3
    .sliderBottom()
    .min(1)
    .max(31)
    .step(1)
    .width(svg.attr("width") - 120)
    // .tickFormat(d3.timeFormat('%Y'))
    .tickValues(dataTime)
    .default(1)
    .on('onchange', val => {

      d3.select('#value-time').text(val);
      d3.select('#value-time-sup').text(`${nth(sliderTime.value())}`);

      // add data
      svg.selectAll(".lines")
        // if you want a transition:
        // .transition();
        // .duration(100)
        // .style("opacity", 0)
        .remove();

      svg.selectAll("myPath")
        .data(link[val-1])
        .enter().append("path")
          .attr("class", "lines")  // need to specify class
          .attr("d", function(d){ return path(d)})
          .style("fill", "none")
          .style("stroke", colourPath)
          .style("stroke-width", 2);
    });

  let gTime = d3
    .select('#slider-time')
    .append('svg')
    .attr('width', svg.attr("width"))
    .attr('height', 100)
    .append('g')
    .attr('transform', 'translate(30,30)');

  gTime.call(sliderTime);

  // Day format
  const nth = function(d) {
  if (d > 3 && d < 21) return 'th';
  switch (d % 10) {
    case 1:  return "st";
    case 2:  return "nd";
    case 3:  return "rd";
    default: return "th";
  }
}
  d3.select('#value-time').text(sliderTime.value());
  d3.select('#value-time-sup').text(nth(sliderTime.value()));

  if (link) d3.select('svg#myPath').data(link[sliderTime.value()]);

  // Controls
  var t;
  function myCounter() {
    t = sliderTime.value();
    if (t==31) {
      sliderTime.value(1);
    } else if (t==30) {
      sliderTime.value(t+1);
      pause();
    } else {
      sliderTime.value(t+1);
    }
  }
  function play() {
    document.getElementById("play").disabled  = true;
    document.getElementById("pause").disabled = false;
    myTimer = setInterval(myCounter, 250);
  }
  function pause() {
    document.getElementById("play").disabled  = false;
    document.getElementById("pause").disabled = true;
    clearInterval(myTimer);
  }
  function reset() {
    document.getElementById("pause").disabled = true;
  }
  // console.log(d3.select('svg#myPath').data(link[sliderTime.value()]));

</script>

</html>
