<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta charset="utf-8">
  <script src="static/d3.v5.js"></script>
  <script src="static/topojson-client.js"></script>
  <script src="static/d3-simple-slider.min.js"></script>
  <!-- <script type="module" src="static/versor.js"></script> -->
  <!-- https://picnicss.com/documentation -->
  <link rel="stylesheet" type="text/css" href="static/picnic.min.css">
  <style type="text/css">
  body {
    margin: auto;
    max-width: 640px;
    /*text-align: center;*/
  }
  svg {
   /* width: 1280px;
    height: 800px;
    pointer-events: all;*/
  }
  sup {
    font-size: x-small
  }
  #footer {
    margin: auto;
    max-width: 640px;
    text-align: left;
  }
  #footer-text {
    font-size: 14px;
    color: #AAA;
  }
  </style>
</head>

<body onload="reset();">
  <div>
    <h2 style="padding-bottom: 0px;">Canadian Airlines and COVID-19</h2>
    <span id="subtitle" style="font-size: 16px; color: #AAA; ">Visualizing 21,609 flights from 1014 aircrafts</span>
    <p>In mid-March 2020, all of Canada's provinces and territories declared states of emergency. Canada severely restricted its border access, barring travellers from all countries with some exceptions.</p><br>
    <h4>Flights per day from Canadian airlines, March 2020</h4>
  </div>
  <div style="font-size: 14px; color: #AAA;">
    <i>Drag to rotate the world.</i>
    <i>Play to animate through the month</i>
  </div>
  <div style="font-size: 14px; ">
    </br>
    <span>March </span><span id="value-time"></span><sup id="value-time-sup"></sup><span>: </span>
    <span id="value-flights"></span><span> flights</span>
  </div>
  <div style="text-align: center;">

    <!-- map -->
    <svg id="map" width="640" height="500"></svg>

  </div>
  <div id="footer" class="row align-items-center">
    <span style="font-size: 14px; margin-left: 120px; color: #AAA;">Day of March:</span>
    <div class="col-sm" style="display: flex;">
      <button id="play" onclick="play();" style="height: 37px; margin-right: 5px; margin-top: 12px;" >▶</button>
      <button id="pause" onclick="pause();" style="height: 37px; width: 51px; margin-top: 12px;" disabled="">▌▌</button>
      <span id="slider-time" onclick="pause();"></span>
    </div>
  </div>
  <div id="footer-text">
     <a href="download.csv" download>csv</a>
    Sources. Canadian Airlines were pulled from wikipedia's page: "List of airlines of Canada" [1]. Aircrafts' owner were taken from OpenSky Network's datasets [2]. Daily flights were pulled from OpenSky Network's API [3]. Date range used was between March 1, 2020 12:00:00 AM GMT and March 31, 2020 11:59:59 PM GMT. Airport coordinates were extracted from OurAirports [4]<br><br>

    Methodology. From the list of Canadian airlines, only (32) airlines with a known callsign were considered. With a callsign, we can filter the (1014) aircrafts owned by Canadian airlines from the aircraft database. Flights with unknown arrival or departure airport were removed. Data's sanity was double-check, but not triple-checked.<br><br>

    Tech. Data is stored in SQLite, and exported as a JSON file. Data processing was done on Python with pandas. D3 Javascript library was used to visualize globe with lots of code from Mike Bostock 2011 <a href="http://mbostock.github.io/d3/talk/20111018/azimuthal.html">talk</a> and Derek Watkins <a href="http://bl.ocks.org/dwtkns/4686432">globe</a>. The minimal library Picnic CSS was used.<br><br>

    Thanks. Dario Saveliovsky for its valuable feedback and support and to you for visiting.<br><br>

    [1] https://en.wikipedia.org/wiki/List_of_airlines_of_Canada<br>
    [2] https://opensky-network.org/datasets/metadata/aircraftDatabase.csv<br>
    [3] https://opensky-network.org/apidoc/<br>
    [4] https://ourairports.com/data/<br><br>
  </div>
</body>

<script>
// Lots of code from:
//  http://bl.ocks.org/dwtkns/4686432
//  http://mbostock.github.io/d3/talk/20111018/azimuthal.html
//  ideal: https://observablehq.com/@d3/versor-dragging

  let colourPath    = "#1E88E510";
  let colourSphere  = "#F8F8F8";
  let colourLand    = "#AAA";
// D3 Map
  // The svg
  let svg = d3.select("svg")
            .on("mousedown", mousedown),
    width = +svg.attr("width"),
    height = +svg.attr("height") - 140;

  // Map and projection
  // projections: geoMercator, geoNaturalEarth1
  let projection = d3.geoOrthographic()
    .scale(220)
    .translate([320,250])
    .clipAngle(90)
    .rotate([90,-25,0]);

  // Path generator
  let path = d3.geoPath()
      .projection(projection);

  // Load world shape
  d3.json("static/land-110m.json")
    .then(function(world) {

      var sphere = {type:"Sphere"};
    
      svg.append("path")
        .datum(sphere)
        .attr("d", path)
        .attr("fill", colourSphere);

      // Draw map
      svg.insert("path", ".graticule")
          .datum(topojson.feature(world, world.objects.land))
          .attr("class", "land")
          .attr("fill", colourLand)
          .style("stroke", colourLand)
          .attr("d", path);

  });

  // Load flights data
  var link;
  d3.json("data.json")
    .then(function(data) {
    link = data;

    let lk = link[0];
    // Add paths
    svg.selectAll("myPath")
      .data(lk)
      .enter().append("path")
        .attr("class", "lines")  // need to specify class
        .attr("d", function(d){ return path(d)})
        .style("fill", "none")
        .style("stroke", colourPath)
        .style("stroke-width", 2);

    // Number of flights
    d3.select('#value-flights').text(lk.length);
  });

  d3.select(window)
    .on("mousemove", mousemove)
    .on("mouseup", mouseup);

  let m0, o0;

  function mousedown() {
    m0 = [d3.event.pageX, d3.event.pageY];
    o0 = projection.rotate();
    d3.event.preventDefault();
  }

  function mousemove() {
    if (m0) {
      let m1 = [d3.event.pageX, d3.event.pageY],
          o1 = [o0[0] + (m1[0] - m0[0]) / 6, o0[1] + (m0[1] - m1[1]) / 6];
      projection.rotate(o1);
      svg.selectAll("path")
       .attr("d", path);
      // refresh();
    }
  }

  function mouseup() {
    if (m0) {
      mousemove();
      m0 = null;
    }
  }

  // SLIDER    
   // Time
  let dataTime = d3.range(1, 32);

  let sliderTime = d3
    .sliderBottom()
    .min(1)
    .max(31)
    .step(1)
    .width(svg.attr("width") - 120)
    // .tickFormat(d3.timeFormat('%Y'))
    .tickValues(dataTime)
    .default(1)
    .on('onchange', val => {

      d3.select('#value-time').text(val);
      d3.select('#value-time-sup').text(`${nth(sliderTime.value())}`);

      // add data
      svg.selectAll(".lines")
        // if you want a transition:
        // .transition();
        // .duration(100)
        // .style("opacity", 0)
        .remove();

      let lk = link[val-1];
      svg.selectAll("myPath")
        .data(lk)
        .enter().append("path")
          .attr("class", "lines")  // need to specify class
          .attr("d", function(d){ return path(d)})
          .style("fill", "none")
          .style("stroke", colourPath)
          .style("stroke-width", 2);

      d3.select('#value-flights').text(lk.length);
    });

  let gTime = d3
    .select('#slider-time')
    .append('svg')
    .attr('width', svg.attr("width"))
    .attr('height', 100)
    .append('g')
    .attr('transform', 'translate(30,30)');

  gTime.call(sliderTime);

  // Day format
  const nth = function(d) {
  if (d > 3 && d < 21) return 'th';
  switch (d % 10) {
    case 1:  return "st";
    case 2:  return "nd";
    case 3:  return "rd";
    default: return "th";
  }
}
  d3.select('#value-time').text(sliderTime.value());
  d3.select('#value-time-sup').text(nth(sliderTime.value()));

  if (link) d3.select('svg#myPath').data(link[sliderTime.value()]);

  // Controls
  var t;
  function myCounter() {
    t = sliderTime.value();
    if (t==31) {
      sliderTime.value(1);
    } else if (t==30) {
      sliderTime.value(t+1);
      pause();
    } else {
      sliderTime.value(t+1);
    }
  }
  function play() {
    document.getElementById("play").disabled  = true;
    document.getElementById("pause").disabled = false;
    myTimer = setInterval(myCounter, 250);
  }
  function pause() {
    document.getElementById("play").disabled  = false;
    document.getElementById("pause").disabled = true;
    clearInterval(myTimer);
  }
  function reset() {
    document.getElementById("pause").disabled = true;
  }
  // console.log(d3.select('svg#myPath').data(link[sliderTime.value()]));

</script>

</html>
