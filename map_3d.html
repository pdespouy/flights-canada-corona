<!DOCTYPE html>
<html>
<head>
  <title></title>
  <meta charset="utf-8">
  <script src="static/d3.v5.js"></script>
  <script src="static/topojson-client.js"></script>
  <script src="static/d3-simple-slider.min.js"></script>
  <script type="module" src="static/versor.js"></script>
</head>

<body>
  <div>
    <!-- map -->
    <svg id="map" width="640" height="600"></svg>
  </div>
  <div class="row align-items-center">
    <div class="col-sm-2"><p id="value-time"></p></div>
    <div class="col-sm"><div id="slider-time"></div></div>
  </div>
</body>

<script>
// Lots of code from:
//  http://bl.ocks.org/dwtkns/4686432
//  http://mbostock.github.io/d3/talk/20111018/azimuthal.html
//  ideal: https://observablehq.com/@d3/versor-dragging

// D3 Map
  // The svg
  let svg = d3.select("svg").on("mousedown", mousedown),
    width = +svg.attr("width"),
    height = +svg.attr("height");

  // Map and projection
  // projections: geoMercator, geoNaturalEarth1
  let projection = d3.geoOrthographic()
    .scale(220)
    .translate([320,320])
    .clipAngle(90)
    .rotate([90,-25,0]);
      // .scale(80)
      // .translate([width/2, height/2*1.24])

  // Create links / edges
  // tojson to escape special characters
  // we parse to convert string to object
  // let link = JSON.parse('{{ links | tojson }}');
  let link = [
    [{"coordinates": [[-79.63, 43.68], [-115.15, 36.08]], "type": "LineString"},
    {"coordinates": [[-82.53, 27.98], [-79.63, 43.68]], "type": "LineString"}],

    [{"coordinates": [[-60.63, 50.68], [-90.15, 50.08]], "type": "LineString"},
    {"coordinates": [[-90.53, 20.98], [-50.63, 33.68]], "type": "LineString"}]
    ];

  // Path generator
  let path = d3.geoPath()
      .projection(projection);

  // Load world shape
  d3.json("static/land-110m.json")
    .then(function(world) {

      var sphere = {type:"Sphere"}
    
      svg.append("path")
        .datum(sphere)
        .attr("d", path)
        .attr("fill","lightblue");

      // Draw map
      svg.insert("path", ".graticule")
          .datum(topojson.feature(world, world.objects.land))
          .attr("class", "land")
          .attr("d", path);

      // Add paths
      svg.selectAll("myPath")
        .data(link[0])
        .enter().append("path")
          .attr("class", "lines")  // need to specify class
          .attr("d", function(d){ return path(d)})
          .style("fill", "none")
          .style("stroke", "red")
          .style("stroke-width", 2)

  });

  d3.select(window)
    .on("mousemove", mousemove)
    .on("mouseup", mouseup);

  let m0, o0;

  function mousedown() {
    m0 = [d3.event.pageX, d3.event.pageY];
    o0 = projection.rotate();
    d3.event.preventDefault();
  }

  function mousemove() {
    if (m0) {
      let m1 = [d3.event.pageX, d3.event.pageY],
          o1 = [o0[0] + (m1[0] - m0[0]) / 6, o0[1] + (m0[1] - m1[1]) / 6];
      projection.rotate(o1);
      svg.selectAll("path")
       .attr("d",path);
      // refresh();
    }
  }

  function mouseup() {
    if (m0) {
      mousemove();
      m0 = null;
    }
  }

    // SLIDER    
    // Time
  var dataTime = d3.range(0, 31);

  var sliderTime = d3
    .sliderBottom()
    .min(0)
    .max(30)
    .step(1)
    .width(svg.attr("width") - 60)
    // .tickFormat(d3.timeFormat('%Y'))
    .tickValues(dataTime)
    .default(0)
    .on('onchange', val => {
      d3.select('p#value-time').text(val);
      // add data
      svg.selectAll(".lines").remove();
      svg.selectAll("myPath")
        .data(link[val])
        .enter().append("path")
          .attr("class", "lines")  // need to specify class
          .attr("d", function(d){ return path(d)})
          .style("fill", "none")
          .style("stroke", "red")
          .style("stroke-width", 2);
    });

  var gTime = d3
    .select('div#slider-time')
    .append('svg')
    .attr('width', svg.attr("width"))
    .attr('height', 100)
    .append('g')
    .attr('transform', 'translate(30,30)');

  gTime.call(sliderTime);

  d3.select('p#value-time').text(sliderTime.value());

  d3.select('svg#myPath').data(link[sliderTime.value()]);
  // console.log(d3.select('svg#myPath').data(link[sliderTime.value()]));

</script>

</html>
